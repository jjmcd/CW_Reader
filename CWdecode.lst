MPASM 03.80 Released                             CWDECODE.ASM   2-11-2005  15:18:05         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ;   CW decode routines
                      00002         include     p16f628.inc
                      00001         LIST
                      00002 ; P16F628.INC  Standard Header File, Version 1.01    Microchip Technology, Inc.
                      00261         LIST
                      00003         include     CWdefs.inc
                      00001 ;   Constants used by multiple routines
                      00002 
                      00003 ;       program constants definitions  
  00000000            00004 swon    equ  0x00
  00000001            00005 swoff   equ  0x01   
                      00006 
                      00007 ;   program settable parameters 
  00000008            00008 chrparm equ  0x08       ; chars number for speed calculation
  00000028            00009 rowparm equ  0x28       ; chars number on the LCD raw
  0000000F            00010 sgparm  equ  0x0f       ; dit/dashes number for param. refresh  
                      00011      
                      00012 ; port_a bits
  00000001            00013 bit_P0  equ 1
  00000002            00014 bit_P1  equ 2
  00000004            00015 bit_CW  equ 4
                      00016 ; port_b bits
  00000003            00017 bit_EN  equ 3
  00000001            00018 bit_RS  equ 1
                      00019 
                      00004         list        b=4,n=70
                      00005 
                      00006 ;   Functions provided
  0000                00007         global      c_minof,c_minon,decod,ag_parm,dec_sg
                      00008 ;   Storage provided
  0000                00009         global      ctrsegn,tmed_on,tmed_of,tmax_of
  0000                00010         global      plval,pldata,speed
                      00011 ;   used by decod
                      00012         ; LCD routines
  0000                00013         extern      wrtlcd,bytelcd
                      00014         ; Table Lookups
  0000                00015         extern      ric_a,ric_b,ric_c,ric_d,ric_e,ric_f
                      00016         ; Storage
  0000                00017         extern      w_conv  ; Binary-ASCII work area
                      00018 ;   used by ag_parm
  0000                00019         extern      moltip          ; Multiply
  0000                00020         extern      w_num2,w_num3   ; Multiply work area
  0000                00021         extern      tmin1_on        ; ON lowest duration
  0000                00022         extern      tmin1_of        ; OFF lowest duration
  0000                00023         extern      tmin2_on        ; ON second shortest
  0000                00024         extern      tmin2_of        ; OFF second shortest
                      00025 ;   used by c_minof
  0000                00026         extern      ord_of          ; Sort routine for off's
  0000                00027         extern      timeoff         ; OFF signal duration
                      00028 ;   used by c_minon
  0000                00029         extern      ord_on          ; Sort routine for on's
                      00030 ;   used by ag_parm and c_minof
  0000                00031         extern      tmin3_of        ; OFF greatest duration
                      00032 ;   used by ag_parm and c_minon
  0000                00033         extern      tmin3_on        ; ON greatest duration
                      00034 ;   used by c_minon and dec_sg
  0000                00035         extern      timeon          ; ON signal duration
                      00036 
                      00037 ;       program variables definitions 
                      00038         udata
0000                  00039 pldata  res         1               ; received dit/dash map (max 8)
0001                  00040 plval   res         1               ; significant dit/dash map (max 8)
0002                  00041 speed   res         1               ;   
                      00042 
MPASM 03.80 Released                             CWDECODE.ASM   2-11-2005  15:18:05         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0003                  00043 tmed_on res         1               ; ON signal mean duration
0004                  00044 tmed_of res         1               ; OFF signal mean duration
0005                  00045 tmax_of res         1               ; interwords pause mean duration
                      00046 
0006                  00047 ctrsegn res         1               ; received signs counter 
                      00048 
                      00049         code
                      00050 ;   Received character decoding routine
                      00051 ;
                      00052 ;   input :     
                      00053 ;   - PLVAL area containing significant bits map
                      00054 ;   - PLDATA area containing received values (0=dit,1=dash) 
                      00055 ;
                      00056 ;   output :
                      00057 ;   - decoded character in w_conv  
                      00058 ;   - decoded character on LCD display
                      00059 ;   
0000                  00060 decod
0000   3020           00061         movlw       " "             ; space default character
0001   00??           00062         movwf       w_conv          ;
0002   08??           00063         movf        plval,F         ; verify PLVAL content
0003   1903           00064         btfsc       STATUS,Z        ; if zero
0004   0008           00065         return                      ; go to end routine 
0005                  00066 decod1  
0005   3001           00067         movlw       d'1'            ; verify if plval = 1
0006   02??           00068         subwf       plval,F         ;
0007   1D03           00069         btfss       STATUS,Z        ;
0008   2???           00070         goto        decod3          ;
0009   2???           00071         call        ric_a           ; and tab A search
000A   2???           00072         goto        endecod
000B                  00073 decod3  
000B   3002           00074         movlw       d'2'            ; verify if plval = 3
000C   02??           00075         subwf       plval,F         ;
000D   1D03           00076         btfss       STATUS,Z        ;
000E   2???           00077         goto        decod7          ;
000F   2???           00078         call        ric_b           ; and tab B search
0010   2???           00079         goto        endecod
                      00080 
0011                  00081 decod7  
0011   3004           00082     movlw    d'4'       ; verify if plval = 7
0012   02??           00083     subwf    plval,F    ;
0013   1D03           00084     btfss    STATUS,Z   ;
0014   2???           00085     goto     decod15    ;
0015   2???           00086     call     ric_c      ; and tab C search
0016   2???           00087     goto     endecod
                      00088     
0017                  00089 decod15 
0017   3008           00090     movlw    d'8'       ; verify if plval = 15
0018   02??           00091     subwf    plval,F    ;
0019   1D03           00092     btfss    STATUS,Z   ;
001A   2???           00093     goto     decod31    ;
001B   2???           00094     call     ric_d      ; and tab D search
001C   2???           00095     goto     endecod
                      00096 
001D                  00097 decod31 
001D   3010           00098     movlw    d'16'      ; verify if plval = 31
001E   02??           00099     subwf    plval,F    ;
001F   1D03           00100     btfss    STATUS,Z   ;
0020   2???           00101     goto     decod63    ;
0021   2???           00102     call     ric_e      ; and tab E search
0022   2???           00103     goto     endecod
                      00104 
0023                  00105 decod63 
0023   3020           00106     movlw    d'32'      ; verify if plval = 63
MPASM 03.80 Released                             CWDECODE.ASM   2-11-2005  15:18:05         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0024   02??           00107     subwf    plval,F    ;
0025   1D03           00108     btfss    STATUS,Z   ;
0026   2???           00109     goto     nodecod    ;
0027   2???           00110     call     ric_f      ; and tab F search
0028   2???           00111     goto     endecod
                      00112 
0029                  00113 nodecod
0029   302A           00114     movlw    "*"
002A                  00115 endecod
002A   00??           00116     movwf    w_conv     ; at end save in w_conv decoded character
002B   00??           00117     movwf    bytelcd
002C   01??           00118     clrf     plval      ; clear PLVAL e PLDATA
002D   01??           00119     clrf     pldata
002E   2???           00120     call     wrtlcd     ; display decoded character
                      00121 
002F   0008           00122     return
                      00123 
                      00124 ;   Received sign decoding routine 
                      00125 ;
                      00126 ;   input : 
                      00127 ;   - received signal duration      
                      00128 ;   - PLVAL area containing map of received signs
                      00129 ;   - PLDATA area containing received values (0=punto, 1=linea) 
                      00130 ;
                      00131 ;   output :
                      00132 ;   - updated PLVAL area  
                      00133 ;   - updated PLDATA area
                      00134 ;   
0030                  00135 dec_sg
0030   1800           00136     btfsc    plval, 0   ; verify if plval = 00000000
0031   2???           00137     goto     dec_sg1    ;
0032   1400           00138     bsf  plval, 0   ; first sign of the received character
0033   08??           00139     movf     tmed_on,W  ;
0034   02??           00140     subwf    timeon,W   ; verify if duration > mean ON time (dit)
0035   1803           00141     btfsc    STATUS,C   ;
0036   1400           00142     bsf  pldata, 0  ; greater duration (dash)
0037   2???           00143     goto     end_sg
0038                  00144 dec_sg1
0038   1880           00145     btfsc    plval, 1   ; verify if plval = 00000001
0039   2???           00146     goto     dec_sg2    ;
003A   1480           00147     bsf  plval, 1   ; second sign of the received character
003B   08??           00148     movf     tmed_on,W  ;
003C   02??           00149     subwf    timeon,W   ; verify if duration > mean ON time (dit)
003D   1803           00150     btfsc    STATUS,C   ;
003E   1480           00151     bsf  pldata, 1  ; greater duration (dash)
003F   2???           00152     goto     end_sg 
0040                  00153 dec_sg2
0040   1900           00154     btfsc    plval, 2   ; verify if plval = 00000011
0041   2???           00155     goto     dec_sg3    ;
0042   1500           00156     bsf  plval, 2   ; third sign of the received character
0043   08??           00157     movf     tmed_on,W  ;
0044   02??           00158     subwf    timeon,W   ; verify if duration > mean ON time (dit)
0045   1803           00159     btfsc    STATUS,C   ;
0046   1500           00160     bsf  pldata, 2  ; greater duration (dash)
0047   2???           00161     goto     end_sg
0048                  00162 dec_sg3
0048   1980           00163     btfsc    plval, 3   ; verify if plval = 00000111
0049   2???           00164     goto     dec_sg4    ;
004A   1580           00165     bsf  plval, 3   ; fourth sign of the received character
004B   08??           00166     movf     tmed_on,W  ;
004C   02??           00167     subwf    timeon,W   ; verify if duration > mean ON time (dit)
004D   1803           00168     btfsc    STATUS,C   ;
004E   1580           00169     bsf  pldata, 3  ; greater duration (dash)
004F   2???           00170     goto     end_sg     
MPASM 03.80 Released                             CWDECODE.ASM   2-11-2005  15:18:05         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0050                  00171 dec_sg4
0050   1A00           00172     btfsc    plval, 4   ; verify if plval = 00001111
0051   2???           00173     goto     dec_sg5    ;
0052   1600           00174     bsf  plval, 4   ; fifth sign of the received character
0053   08??           00175     movf     tmed_on,W  ;
0054   02??           00176     subwf    timeon,W   ; verify if duration > mean ON time (dit)
0055   1803           00177     btfsc    STATUS,C   ;
0056   1600           00178     bsf  pldata, 4  ; greater duration (dash)
0057   2???           00179     goto     end_sg
0058                  00180 dec_sg5
0058   1A80           00181     btfsc    plval, 5   ; verify if plval = 00011111
0059   2???           00182     goto     dec_sg6    ;
005A   1680           00183     bsf  plval, 5   ; sixth sign of the received character
005B   08??           00184     movf     tmed_on,W  ;
005C   02??           00185     subwf    timeon,W   ; verify if duration > mean ON time (dit)
005D   1803           00186     btfsc    STATUS,C   ;
005E   1680           00187     bsf  pldata, 5  ; greater duration (dash)
005F   2???           00188     goto     end_sg 
0060                  00189 dec_sg6
0060   1700           00190     bsf  plval, 6   ; if more than six signs set a default      
0061                  00191 end_sg  
0061   0008           00192     return
                      00193 
                      00194 ;   Working parameters calculation routine
                      00195 ;   
                      00196 ;   tmed_on 
                      00197 ;   tmed_of    
                      00198 ;   tmax_of      
                      00199 ;
0062                  00200 ag_parm
                      00201 ;   tmed_on computing
0062   08??           00202     movf     tmin3_on,W
0063   00??           00203     movwf    w_num2     ; multiplicand in w_num2
0064   3002           00204     movlw    d'2'
0065   00??           00205     movwf    w_num3     ; 2 in w_num3
0066   2???           00206     call     moltip
0067   08??           00207     movf     w_num2,W
0068   00??           00208     movwf    tmed_on
                      00209 
                      00210 ;   tmed_of computing
0069   08??           00211     movf     tmin3_of,W
006A   00??           00212     movwf    w_num2     ; multiplicand in w_num2
006B   3002           00213     movlw    d'2'
006C   00??           00214     movwf    w_num3     ; 2 in w_num3
006D   2???           00215     call     moltip
006E   08??           00216     movf     w_num2,W
006F   00??           00217     movwf    tmed_of
                      00218 
                      00219 ;   tmax_of computing
0070   08??           00220     movf     tmin3_of,W
0071   00??           00221     movwf    w_num2     ; multiplicand in w_num2
0072   3005           00222     movlw    d'5'
0073   00??           00223     movwf    w_num3     ; 5 in w_num3
0074   2???           00224     call     moltip
0075   08??           00225     movf     w_num2,W   ; compute tmax_of = tmin_of * 5
0076   00??           00226     movwf    tmax_of
                      00227 
0077   01??           00228     clrf     ctrsegn
0078   30FF           00229     movlw    0xff
0079   00??           00230     movwf    tmin1_on
007A   00??           00231     movwf    tmin2_on
007B   00??           00232     movwf    tmin3_on
007C   00??           00233     movwf    tmin1_of
007D   00??           00234     movwf    tmin2_of
MPASM 03.80 Released                             CWDECODE.ASM   2-11-2005  15:18:05         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

007E   00??           00235     movwf    tmin3_of
007F   0008           00236     return
                      00237 
                      00238 ;   Minimum ON time calculation routine.
                      00239 ;   stores the three lowest measured values 
                      00240 ;   in the observation interval (sgparm = received signs)    
0080                  00241 c_minon
0080   3003           00242     movlw    d'3'       ; verify if timeon < 30 ms
0081   02??           00243     subwf    timeon,W   ; if so no computing is done
0082   1C03           00244     btfss    STATUS,C   ; 
0083   2???           00245     goto     end_mon    
0084   08??           00246     movf     timeon,W   ; 
0085   02??           00247     subwf    tmin3_on,W ; calculate tmin3_on - timeon
0086   1C03           00248     btfss    STATUS,C   ;
0087   2???           00249     goto     end_mon    ; if result < 0 exit
0088   08??           00250     movf     timeon,W   ; otherwise substitute for tmin3_on
0089   00??           00251     movwf    tmin3_on   ;
008A   2???           00252     call     ord_on     ; and tabel reorg 
008B                  00253 end_mon
008B   0008           00254     return  
                      00255 
                      00256 ;   Minimum OFF time calculation routine.
                      00257 ;   stores the three lowest measured values 
                      00258 ;   in the observation interval (sgparm = received signs) 
008C                  00259 c_minof
008C   3003           00260     movlw    d'3'       ; verify if timeoff < 30 ms
008D   02??           00261     subwf    timeoff,W  ; if so no computing is done
008E   1C03           00262     btfss    STATUS,C   ; 
008F   2???           00263     goto     end_mof    ;
0090   08??           00264     movf     timeoff,W  ; 
0091   02??           00265     subwf    tmin3_of,W ; calculate tmin3_of - timeoff
0092   1C03           00266     btfss    STATUS,C   ;
0093   2???           00267     goto     end_mof    ; if result < 0 exit
0094   08??           00268     movf     timeoff,W  ; otherwise substitute for tmin3_of
0095   00??           00269     movwf    tmin3_of   ;
0096   2???           00270     call     ord_of     ; and tabel reorg
0097                  00271 end_mof
0097   0008           00272     return  
                      00273 
                      00274 
                      00275 
                      00276 
                      00277 
                      00278         end
MPASM 03.80 Released                             CWDECODE.ASM   2-11-2005  15:18:05         PAGE  6


SYMBOL TABLE
  LABEL                             VALUE 

ADEN                              00000003
BRGH                              00000002
C                                 00000000
C1INV                             00000004
C1OUT                             00000006
C2INV                             00000005
C2OUT                             00000007
CCP1CON                           00000017
CCP1IE                            00000002
CCP1IF                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCP1X                             00000005
CCP1Y                             00000004
CCPR1H                            00000016
CCPR1L                            00000015
CIS                               00000003
CM0                               00000000
CM1                               00000001
CM2                               00000002
CMCON                             0000001F
CMIE                              00000006
CMIF                              00000006
CREN                              00000004
CSRC                              00000007
DC                                00000001
EEADR                             0000009B
EECON1                            0000009C
EECON2                            0000009D
EEDATA                            0000009A
EEIE                              00000007
EEIF                              00000007
F                                 00000001
FERR                              00000002
FSR                               00000004
GIE                               00000007
INDF                              00000000
INTCON                            0000000B
INTE                              00000004
INTEDG                            00000006
INTF                              00000001
IRP                               00000007
NOT_BO                            00000000
NOT_BOD                           00000000
NOT_BOR                           00000000
NOT_PD                            00000003
NOT_POR                           00000001
NOT_RBPU                          00000007
NOT_T1SYNC                        00000002
NOT_TO                            00000004
OERR                              00000001
OPTION_REG                        00000081
OSCF                              00000003
PCL                               00000002
PCLATH                            0000000A
PCON                              0000008E
PEIE                              00000006
PIE1                              0000008C
PIR1                              0000000C
PORTA                             00000005
PORTB                             00000006
PR2                               00000092
MPASM 03.80 Released                             CWDECODE.ASM   2-11-2005  15:18:05         PAGE  7


SYMBOL TABLE
  LABEL                             VALUE 

PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
RBIE                              00000003
RBIF                              00000000
RCIE                              00000005
RCIF                              00000005
RCREG                             0000001A
RCSTA                             00000018
RD                                00000000
RP0                               00000005
RP1                               00000006
RX9                               00000006
RX9D                              00000000
SPBRG                             00000099
SPEN                              00000007
SREN                              00000005
STATUS                            00000003
SYNC                              00000004
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0SE                              00000004
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000010
T1OSCEN                           00000003
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000012
TMR0                              00000001
TMR1CS                            00000001
TMR1H                             0000000F
TMR1IE                            00000000
TMR1IF                            00000000
TMR1L                             0000000E
TMR1ON                            00000000
TMR2                              00000011
TMR2IE                            00000001
TMR2IF                            00000001
TMR2ON                            00000002
TOUTPS0                           00000003
TOUTPS1                           00000004
TOUTPS2                           00000005
TOUTPS3                           00000006
TRISA                             00000085
TRISB                             00000086
TRMT                              00000001
TX9                               00000006
TX9D                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXREG                             00000019
TXSTA                             00000098
VR0                               00000000
VR1                               00000001
VR2                               00000002
VR3                               00000003
VRCON                             0000009F
VREN                              00000007
VROE                              00000006
VRR                               00000005
MPASM 03.80 Released                             CWDECODE.ASM   2-11-2005  15:18:05         PAGE  8


SYMBOL TABLE
  LABEL                             VALUE 

W                                 00000000
WR                                00000001
WREN                              00000002
WRERR                             00000003
Z                                 00000002
_BODEN_OFF                        00003FBF
_BODEN_ON                         00003FFF
_CP_50                            00002BFF
_CP_75                            000017FF
_CP_ALL                           000003FF
_CP_OFF                           00003FFF
_DATA_CP_OFF                      00003FFF
_DATA_CP_ON                       00003EFF
_ER_OSC_CLKOUT                    00003FFF
_ER_OSC_NOCLKOUT                  00003FFE
_EXTCLK_OSC                       00003FEF
_HS_OSC                           00003FEE
_INTRC_OSC_CLKOUT                 00003FFD
_INTRC_OSC_NOCLKOUT               00003FFC
_LP_OSC                           00003FEC
_LVP_OFF                          00003F7F
_LVP_ON                           00003FFF
_MCLRE_OFF                        00003FDF
_MCLRE_ON                         00003FFF
_PWRTE_OFF                        00003FFF
_PWRTE_ON                         00003FF7
_WDT_OFF                          00003FFB
_WDT_ON                           00003FFF
_XT_OSC                           00003FED
__16F628                          00000001
ag_parm                           00000062
bit_CW                            00000004
bit_EN                            00000003
bit_P0                            00000001
bit_P1                            00000002
bit_RS                            00000001
bytelcd                           00000000
c_minof                           0000008C
c_minon                           00000080
chrparm                           00000008
ctrsegn                           00000006
dec_sg                            00000030
dec_sg1                           00000038
dec_sg2                           00000040
dec_sg3                           00000048
dec_sg4                           00000050
dec_sg5                           00000058
dec_sg6                           00000060
decod                             00000000
decod1                            00000005
decod15                           00000017
decod3                            0000000B
decod31                           0000001D
decod63                           00000023
decod7                            00000011
end_mof                           00000097
end_mon                           0000008B
end_sg                            00000061
endecod                           0000002A
moltip                            00000000
nodecod                           00000029
ord_of                            00000000
ord_on                            00000000
pldata                            00000000
MPASM 03.80 Released                             CWDECODE.ASM   2-11-2005  15:18:05         PAGE  9


SYMBOL TABLE
  LABEL                             VALUE 

plval                             00000001
ric_a                             00000000
ric_b                             00000000
ric_c                             00000000
ric_d                             00000000
ric_e                             00000000
ric_f                             00000000
rowparm                           00000028
sgparm                            0000000F
speed                             00000002
swoff                             00000001
swon                              00000000
timeoff                           00000000
timeon                            00000000
tmax_of                           00000005
tmed_of                           00000004
tmed_on                           00000003
tmin1_of                          00000000
tmin1_on                          00000000
tmin2_of                          00000000
tmin2_on                          00000000
tmin3_of                          00000000
tmin3_on                          00000000
w_conv                            00000000
w_num2                            00000000
w_num3                            00000000
wrtlcd                            00000000

Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,     0 suppressed

